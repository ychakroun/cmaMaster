<?php

namespace homePageBundle\Controller;

use Symfony\Component\HttpFoundation\Response;
use Symfony\Bundle\FrameworkBundle\Controller\Controller;
use Symfony\Component\Security\Core\Exception\AccessDeniedException;
use Symfony\Component\HttpFoundation\Request;
use Doctrine\ORM\EntityManager;
use CmaUserBundle\Form\ProposalType;
use CmaUserBundle\Entity\Proposal;

class ProposalController extends Controller
{
    public function showAction()
    {
      $user = $this->get('security.token_storage')->getToken()->getUser();
      if(!is_object($user)){
        throw new AccessDeniedException('This user does not have access to this section.');
      }
      if($user->getRoles()[0]=='ROLE_ARTIST'){
        $existingProposals = $this->getDoctrine()->getManager()->getRepository('CmaUserBundle:Proposal')->findAll();
        $Proposals = array();
        $userProposals = $user->getProposals();
        foreach ($existingProposals as $key => $existingProposal) {
          if(count($userProposals)>0){
            foreach ($userProposals as $key1 => $userProposal) {
            if($userProposal->getId()!=$existingProposal->getId()&&$existingProposal->getIsPublic()){
              array_push($Proposals, $existingProposal);
              }
            }
          }else if($existingProposal->getIsPublic()===true){
            array_push($Proposals, $existingProposal);
          }
        }
      }
      else 
      {
        $Proposals = $user->getProposals();
        $Proposals;
      }
      dump($Proposals);
      return $this->render('homePageBundle:Proposal:Proposal_show.html.twig',array('Proposals'=>$Proposals));
    }
    public function createAction(Request $request)
    {
      $user = $this->get('security.token_storage')->getToken()->getUser();
      if (!is_object($user)) {
        throw new AccessDeniedException('This user does not have access to this section.');
      }
      $Proposal = new Proposal();
      $formProposal = $this->createForm(ProposalType::class,$Proposal);
      $formProposal->handleRequest($request);
        if ($formProposal->isValid()) {
            if($formProposal->get('submit')->isClicked()){
              $Proposal->setIsPublic(true);
            }else if($formProposal->get('save')->isClicked()){
              $Proposal->setIsPublic(false);
            }
            $em = $this->getDoctrine()->getManager();
            $em->persist($Proposal);
            $user->addProposal($Proposal);
            $em->persist($user);
            $em->flush();
            return $this->redirect($this->generateUrl('user_devis'));
        }
      return $this->render('homePageBundle:Proposal:Proposal_create.html.twig',array('username'=>$user->getUsername(),'formProposal' => $formProposal->createView()));
    }
    public function deleteAction(Request $request,$id)
    {
      $user = $this->get('security.token_storage')->getToken()->getUser();
      $userProposals = $user->getProposals();
      $Proposal = $this->getDoctrine()->getManager()->getRepository('CmaUserBundle:Proposal')->findById($id)[0];
      foreach ($userProposals as $key => $userProposal) {
        if($userProposal->getId()==$Proposal->getId()){
          $em = $this->getDoctrine()->getManager();
          $user->removeProposal($Proposal); 
          $em->remove($Proposal);
          $em->persist($user);
          $em->flush();
          return $this->redirect($this->generateUrl('user_devis'));
        }
      }
      throw new AccessDeniedException('This user does not have access to this section.');
    }
    public function updateAction(Request $request,$id)
    {
      $user = $this->get('security.token_storage')->getToken()->getUser();
      $userProposals = $user->getProposals();
      $Proposal = $this->getDoctrine()->getManager()->getRepository('CmaUserBundle:Proposal')->findById($id)[0];
      $user->removeProposal($Proposal);
      $formProposal = $this->createForm(ProposalType::class,$Proposal);
      $formProposal->handleRequest($request);
      if ($formProposal->isValid()) {
            if($formProposal->get('submit')->isClicked()){
              $Proposal->setIsPublic(true);
            }else if($formProposal->get('save')->isClicked()){
              $Proposal->setIsPublic(false);
            }
            dump($Proposal);
            $em = $this->getDoctrine()->getManager();
            $em->persist($Proposal);
            $user->addProposal($Proposal);
            $em->persist($user);
            $em->flush();
            return $this->redirect($this->generateUrl('user_devis'));
        }
      return $this->render('homePageBundle:Proposal:Proposal_edit.html.twig',array('username'=>$user->getUsername(),'formProposal' => $formProposal->createView()));
    }
    public function editAction(Request $request,$id)
    {
      $user = $this->get('security.token_storage')->getToken()->getUser();
      $userProposals = $user->getProposals();
      $Proposal = $this->getDoctrine()->getManager()->getRepository('CmaUserBundle:Proposal')->findById($id)[0];
      foreach ($userProposals as $key => $userProposal) {
        if($userProposal->getId()==$Proposal->getId()){
          $formProposal = $this->createForm(ProposalType::class,$Proposal,array( 'action' => $this->generateUrl('user_Proposal_update',array('id'=>$Proposal->getId()))));
          if(!$Proposal->getIsPublic())
          {
            return $this->redirect($this->generateUrl('user_Proposal_update'),array('Proposal'=>$Proposal->getId()));
          }
          return $this->render('homePageBundle:Proposal:Proposal_edit_public.html.twig',array('username'=>$user->getUsername(),'Proposal'=>$Proposal,'formProposal' => $formProposal->createView()));
        }
      }
      if($user->getRoles()[0]=='ROLE_ARTIST'){
        return $this->redirectToRoute('user_Proposal_proposal_create',array('id'=>$Proposal->getId()));
      }
      throw new AccessDeniedException('This user does not have access to this section.');
    }
}